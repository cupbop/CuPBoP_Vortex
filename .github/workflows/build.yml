name: build

on:
  push:
    paths-ignore:
      - '*.md'

  pull_request:
    paths-ignore:
      - '*.md'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v2
      - name: Install LLVM and Clang
        uses: KyleMayes/install-llvm-action@v1
        with:
          version: "14.0"

      - name: Download vortex header
        run: |
          cd ${{ github.workspace }}
          export CuPBoP_PATH=`pwd`
          wget 'https://www.dropbox.com/scl/fi/nd924ma3cq1fhauo0bs8x/vortex-header.tar.gz?rlkey=zudpp29yuxcrn42mxkiga8e06&dl=1' -O vortex-header.tar.gz
          tar -xzf vortex-header.tar.gz
          cp vortex.h $CuPBoP_PATH/runtime/include

      - name: Download CUDA header files
        run: |
          cd ${{ github.workspace }}
          wget https://www.dropbox.com/s/r18io0zu3idke5p/cuda-header.tar.gz?dl=1
          tar -xzf 'cuda-header.tar.gz?dl=1'
          cp -r include/* runtime/threadPool/include/

      - name: Download CUDA files used for compiling NVVM IR
        run: |
          cd ${{ github.workspace }}
          wget https://www.dropbox.com/s/4pckqsjnl920gpn/cuda-10.1.tar.gz?dl=1
          tar -xzf 'cuda-10.1.tar.gz?dl=1'

      - name: Build project
        run: |
          cd ${{ github.workspace }}
          export CuPBoP_PATH=`pwd`
          export LD_LIBRARY_PATH=$CuPBoP_PATH/build/runtime:$CuPBoP_PATH/build/runtime/threadPool:$LD_LIBRARY_PATH
          export VORTEX_ARCHITECTURE=64
          mkdir build
          cd build
          cmake .. -DLLVM_CONFIG_PATH=`which llvm-config` -DCUDA_PATH=${{ github.workspace }}/cuda-10.1
          make -j8

          echo "Generate bitcode files (.bc) for host/device"
          export CUDA_PATH=$CuPBoP_PATH/cuda-10.1
          export VORTEX_SCHEDULE_FLAG=0
          export KERNEL_CU=saxpy.cu
          export ARCH=64
          export KERNEL=`basename $KERNEL_CU .cu`
          cd ${CuPBoP_PATH}/examples/microbench
          clang++ -O0 -g -std=c++11  ./$KERNEL_CU -I../.. --cuda-path=$CUDA_PATH --cuda-gpu-arch=sm_50 -L$CUDA_PATH/lib64 -lcudart_static -ldl -lrt -pthread -save-temps -v  || true

          echo "Generate LLVM IR files(.ll) for host and device"
          llvm-dis $KERNEL-cuda-nvptx64-nvidia-cuda-sm_50.bc
          llvm-dis $KERNEL-host-x86_64-unknown-linux-gnu.bc
          echo "Translate the kernel bitcode by using CuPBoP's kernel translator"
          $CuPBoP_PATH/build/compilation/kernelTranslator $KERNEL-cuda-nvptx64-nvidia-cuda-sm_50.bc kernel.bc
          llvm-dis kernel.bc

          echo "Translate the host bitcode by using CuPBoP's host translator"
          $CuPBoP_PATH/build/compilation/hostTranslator $KERNEL-host-x86_64-unknown-linux-gnu.bc host.bc
          llvm-dis host.bc
          llc --relocation-model=pic --filetype=obj host.bc -o host.o
          g++ -g -O0 host_vortexrt.cpp -c -o host_vortexrt.o
          
          echo "Download vortex dependencies"
          cd ${CuPBoP_PATH}
          wget -O VORTEX_DIR.tar.gz "https://www.dropbox.com/scl/fi/ywhj90xj6t80cgqsnkze3/VORTEX_DIR.tar.gz?rlkey=156ajyxnwf98pscx75imjxwu9"
          tar -xzf VORTEX_DIR.tar.gz

          echo "Compile the translated bc code for vortex"
          export VX_VXFLAGS="-Xclang -target-feature -Xclang +vortex"
          export VORTEX_PATH=${CuPBoP_PATH}/VORTEX_DIR
          if [ $ARCH = 32 ]
          then
              VX_CFLAGS="-v -O3 -std=c++11 -march=rv32imf -mabi=ilp32f -mcmodel=medany -fno-rtti -fno-exceptions -nostartfiles -fdata-sections -ffunction-sections -I${VORTEX_PATH}/kernel/include -I${VORTEX_PATH}/hw"
              VX_LDFLAGS="-Wl,-Bstatic,-T,${VORTEX_PATH}/kernel/linker/vx_link32.ld,--defsym=STARTUP_ADDR=0x80000000 -Wl,--gc-sections ${VORTEX_PATH}/kernel/libvortexrt.a"
          else
              VX_CFLAGS="-v -O3 -std=c++11 --sysroot=/opt/riscv64-gnu-toolchain/riscv64-unknown-elf --target=riscv64 -march=rv64imafd -mabi=lp64d -mcmodel=medany -fno-rtti -fno-exceptions -nostartfiles -fdata-sections -ffunction-sections -I${VORTEX_PATH}/kernel/include -I${VORTEX_PATH}/hw"
              VX_LDFLAGS="-Wl,-Bstatic,-T,${VORTEX_PATH}/kernel/linker/vx_link64.ld,--defsym=XLEN=64,--defsym=STARTUP_ADDR=0x180000000 -Wl,--gc-sections ${VORTEX_PATH}/kernel/libvortexrt.a"
          fi

          echo "--- compiling kernel.bc"
          cd 
          export LLVM_PREFIX=${CuPBoP_PATH}/llvm
          cd ${CuPBoP_PATH}/examples/microbench
          ${LLVM_PREFIX}/bin/clang++ ${VX_CFLAGS} ${VX_VXFLAGS} -I/home/runner/work/CuPBoP_dev/CuPBoP_dev/VORTEX_DIR/kernel/include kernel.bc -c -o kernel.o > kernel.log

          echo "--- compiling kernel_wrapper.cpp"
          pwd
          find ./* -name "vx_print.h"
          ls ${CuPBoP_PATH}
          echo "ls current folder"
          ls ${{ github.workspace }}
          ${LLVM_PREFIX}/bin/clang++ ${VX_CFLAGS} -I/home/runner/work/CuPBoP_dev/CuPBoP_dev/VORTEX_DIR/kernel/include --gcc-toolchain=${RISCV_TOOLCHAIN_FOLDER} ../vortex_debug/kernel_wrapper.cpp -c -o kernel_wrapper.o 
          ${LLVM_PREFIX}/bin/llvm-objdump -D kernel_wrapper.o > kernel_wrapper.dump

